<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Donasi Bencana Sumatera</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>

    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <!-- 1. LOAD LIBRARY PDF DI SINI (Supaya Urutan Pasti Benar & Stabil) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Camera, Upload, FileText, Lock, Download, Calendar, Clock, CreditCard, User, CheckCircle, ChevronLeft, ScanLine, Keyboard, Trash2, AlertTriangle, Settings, Wifi, WifiOff } from 'lucide-react';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "firebase/firestore";

        // =================================================================
        // ⚠️ PASTE CONFIG FIREBASE ANDA DI SINI
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD8UEoLv5UtK6i_ZeHYaYH8UzO7WY-IaGc",
            authDomain: "lap-donasi-sumatera.firebaseapp.com",
            projectId: "lap-donasi-sumatera",
            storageBucket: "lap-donasi-sumatera.firebasestorage.app",
            messagingSenderId: "896014709046",
            appId: "1:896014709046:web:491fbe1af2848245a2839"
        };
        // =================================================================

        let app, auth, db;
        const COLLECTION_NAME = "donasi_bencana_sumatera";

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase Init Error:", error);
        }

        function App() {
            const [activeTab, setActiveTab] = useState('list');
            const [donations, setDonations] = useState([]);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [connectionStatus, setConnectionStatus] = useState("Menghubungkan...");
            const [statusColor, setStatusColor] = useState("bg-yellow-500");

            // 1. Auth & Connection Check
            useEffect(() => {
                const initAuth = async () => {
                    if (!auth) {
                        setConnectionStatus("Config Error: Cek Firebase Config");
                        setStatusColor("bg-red-600");
                        return;
                    }
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth error:", error);
                        setConnectionStatus(`Auth Gagal: ${error.code}. Aktifkan Anonymous Auth di Console.`);
                        setStatusColor("bg-red-600");
                    }
                };
                initAuth();

                if (auth) {
                    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                        setUser(currentUser);
                        if (currentUser) {
                            setConnectionStatus("Terhubung ke Server");
                            setStatusColor("bg-emerald-600");
                        } else {
                            setConnectionStatus("Tidak Terhubung (User Null)");
                            setStatusColor("bg-gray-500");
                        }
                    });
                    return () => unsubscribe();
                }
            }, []);

            // 2. Data Fetching
            useEffect(() => {
                if (!user || !db) {
                    setLoading(false); 
                    return;
                }
                
                try {
                    const q = query(collection(db, COLLECTION_NAME));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDonations(docs);
                        setLoading(false);
                    }, (err) => { 
                        console.error(err); 
                        setLoading(false);
                        if (err.code === 'permission-denied') {
                            setConnectionStatus("Izin Ditolak: Cek Firestore Rules");
                            setStatusColor("bg-red-600");
                        } else {
                            setConnectionStatus(`Error Database: ${err.code}`);
                            setStatusColor("bg-red-600");
                        }
                    });
                    return () => unsubscribe();
                } catch (e) {
                    console.error("Query Error", e);
                }
            }, [user]);

            // Delete
            const handleDelete = async (id) => {
                if(!db) return alert("Database belum siap.");
                try { await deleteDoc(doc(db, COLLECTION_NAME, id)); alert("Data terhapus!"); }
                catch (e) { alert("Gagal hapus: " + e.message); }
            };

            // Utilities
            const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
            const maskName = (n) => !n ? "" : n.split(' ').map(w => w.length<=1 ? w : w[0]+'*'.repeat(w.length-1)).join(' ');
            const sortedDonations = [...donations].sort((a,b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));
            const total = donations.reduce((acc, c) => acc + Number(c.amount), 0);

            return (
                <div className="min-h-screen pb-10 relative">
                    <header className="bg-emerald-700 text-white shadow-lg">
                        <div className="container mx-auto px-4 py-6">
                            <div className="flex flex-col md:flex-row justify-between gap-4">
                                <div>
                                    <h1 className="text-2xl font-bold uppercase tracking-wider">Laporan Penerimaan Donasi</h1>
                                    <p className="text-emerald-100 text-sm mt-1">Bencana Banjir & Longsor (Aceh, Sumut, Sumbar)</p>
                                    <div className="mt-2 text-xs font-semibold bg-emerald-800/50 inline-block px-3 py-1 rounded-full">ZIS Mu'adz bin Jabal • LAZSIP • SIP</div>
                                </div>
                                <div className="bg-white/10 p-4 rounded-lg text-center min-w-[200px] border border-white/20">
                                    <p className="text-xs text-emerald-100 uppercase mb-1">Total Terkumpul</p>
                                    <p className="text-2xl font-bold">{formatRupiah(total)}</p>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 -mt-4 relative z-10">
                        <div className="bg-white rounded-lg shadow-md p-2 flex gap-2">
                            <button onClick={()=>setActiveTab('list')} className={`flex-1 py-3 rounded-md font-medium text-sm flex justify-center items-center gap-2 ${activeTab==='list'?'bg-emerald-100 text-emerald-800':'hover:bg-gray-100'}`}><FileText size={18}/> Laporan</button>
                            <button onClick={()=>setActiveTab('input')} className={`flex-1 py-3 rounded-md font-medium text-sm flex justify-center items-center gap-2 ${activeTab==='input'?'bg-emerald-100 text-emerald-800':'hover:bg-gray-100'}`}><Lock size={18}/> Input</button>
                        </div>
                    </div>

                    <main className="container mx-auto px-4 py-6 mb-10">
                        {activeTab === 'list' ? 
                            <DonationList data={sortedDonations} mask={maskName} fmt={formatRupiah} onDelete={handleDelete} load={loading}/> 
                            : 
                            <InputForm setTab={setActiveTab} user={user} db={db} col={COLLECTION_NAME}/>
                        }
                    </main>

                    {/* Status Bar */}
                    <div className={`fixed bottom-0 left-0 right-0 ${statusColor} text-white text-xs py-2 px-4 text-center font-bold shadow-lg z-50 flex items-center justify-center gap-2`}>
                        {statusColor === 'bg-emerald-600' ? <Wifi size={14}/> : <WifiOff size={14}/>}
                        Status: {connectionStatus}
                    </div>
                </div>
            );
        }

        function DonationList({ data, mask, fmt, onDelete, load }) {
            const [pinModal, setPinModal] = useState({ show: false, type: '', id: null });
            const [pin, setPin] = useState("");
            
            const handleExport = () => {
                // Pengecekan Library agar tidak crash silent
                if(!window.jspdf) return alert("Library PDF belum termuat sempurna. Mohon refresh halaman.");
                
                try {
                    const doc = new window.jspdf.jsPDF();
                    
                    // Cek apakah Plugin AutoTable sudah siap
                    if (typeof doc.autoTable !== 'function') {
                        throw new Error("Plugin Tabel belum siap. Mohon refresh halaman.");
                    }

                    doc.text("LAPORAN DONASI BENCANA SUMATERA", 105, 15, {align:'center'});
                    doc.autoTable({
                        head: [["No","Tanggal","Jam","Nama","Bank","Nominal"]],
                        body: data.map((d,i)=>[
                            i+1, 
                            d.date, 
                            d.time, 
                            d.name, 
                            d.bank, 
                            new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(d.amount)
                        ]),
                        startY: 25
                    });
                    doc.save("Laporan_Donasi.pdf");
                    setPinModal({show:false});
                    alert("PDF berhasil diunduh!");
                } catch (error) {
                    console.error("Export Error:", error);
                    alert("Gagal Export PDF: " + error.message);
                }
            }

            const checkPin = (e) => {
                e.preventDefault();
                if(pinModal.type === 'export' && pin === "99887766") handleExport();
                else if(pinModal.type === 'delete' && pin === "11335577") { onDelete(pinModal.id); setPinModal({show:false}); }
                else alert("PIN SALAH");
            }

            return (
                <div className="fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-semibold text-gray-700 flex items-center gap-2"><Clock size={20} className="text-emerald-600"/> Riwayat</h2>
                        <button onClick={()=>{setPin("");setPinModal({show:true,type:'export'})}} className="bg-red-600 text-white text-sm px-4 py-2 rounded-lg flex items-center gap-2"><Download size={16}/> PDF</button>
                    </div>
                    <div className="bg-white rounded-xl shadow border overflow-hidden">
                        {load ? <div className="p-8 text-center">Loading...</div> : data.length===0 ? <div className="p-8 text-center text-gray-500">Belum ada data.<br/><span className="text-xs">Jika Anda sudah input tapi data tidak muncul, cek Status Bar di bawah.</span></div> :
                        <div className="overflow-x-auto"><table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-600 uppercase border-b"><tr><th className="px-4 py-3">Waktu</th><th className="px-4 py-3">Donatur</th><th className="px-4 py-3">Bank</th><th className="px-4 py-3 text-right">Nominal</th><th className="px-4 py-3 text-center">Aksi</th></tr></thead>
                            <tbody className="divide-y">{data.map(d=>(
                                <tr key={d.id} className="hover:bg-gray-50"><td className="px-4 py-3"><div>{d.date}</div><div className="text-xs text-gray-500">{d.time}</div></td><td className="px-4 py-3 font-medium">{mask(d.name)}</td><td className="px-4 py-3"><span className="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs">{d.bank}</span></td><td className="px-4 py-3 text-right font-bold text-emerald-700">{fmt(d.amount)}</td><td className="px-4 py-3 text-center"><button onClick={()=>{setPin("");setPinModal({show:true,type:'delete',id:d.id})}} className="text-gray-300 hover:text-red-500"><Trash2 size={16}/></button></td></tr>
                            ))}</tbody>
                        </table></div>}
                    </div>
                    {pinModal.show && <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 px-4">
                        <div className="bg-white p-6 rounded-lg w-full max-w-sm relative">
                            <button onClick={()=>setPinModal({show:false})} className="absolute top-4 right-4">✕</button>
                            <h3 className="text-center font-bold mb-4">{pinModal.type==='export'?'PIN Admin Export':'PIN Admin Hapus'}</h3>
                            <form onSubmit={checkPin}>
                                <input type="password" value={pin} onChange={e=>setPin(e.target.value)} className="w-full border rounded p-2 text-center text-xl mb-4" placeholder="Masukkan PIN" autoFocus/>
                                <button className="w-full bg-emerald-600 text-white py-2 rounded">Verifikasi</button>
                                <p className="text-xs text-gray-400 text-center mt-2">PIN hubungi admin</p>
                            </form>
                        </div>
                    </div>}
                </div>
            )
        }

        function InputForm({ setTab, user, db, col }) {
            const [auth, setAuth] = useState(false);
            const [pin, setPin] = useState("");
            const [mode, setMode] = useState('select');
            const [preview, setPreview] = useState(null);
            const [scanning, setScan] = useState(false);
            const [form, setForm] = useState({ name:"", date: new Date().toISOString().split('T')[0], time: new Date().toLocaleTimeString('en-GB').slice(0,5), amount:"", bank:"" });

            const handleFile = (e) => {
                if(e.target.files[0]) {
                    setPreview(URL.createObjectURL(e.target.files[0]));
                    setScan(true);
                    setTimeout(() => {
                        setScan(false);
                        setForm({ name: "Hamba Allah (Hasil Scan)", date: new Date().toISOString().split('T')[0], time: new Date().toLocaleTimeString('en-GB').slice(0,5), amount: "200000", bank: "BSI" });
                        setMode('manual');
                        alert("Scan selesai! Data terisi otomatis. Silakan klik Simpan.");
                    }, 1500);
                }
            }

            const save = async (e) => {
                e.preventDefault();
                if(!db) return alert("Koneksi Database Gagal. Cek Config.");
                if(!user) return alert("Gagal Simpan: Anda belum login ke sistem (Auth Error).");
                if(!form.name || !form.amount) return alert("Lengkapi data");
                
                try {
                    await addDoc(collection(db, col), {...form, amount:Number(form.amount)});
                    alert("Berhasil disimpan!"); setTab('list');
                } catch(e) { 
                    console.error("Save Error:", e);
                    if(e.code === 'permission-denied') {
                        alert("GAGAL SIMPAN: Izin Ditolak.\n\nSolusi: Buka Firebase Console -> Firestore Database -> Rules -> Ubah 'allow read, write: if false;' menjadi 'allow read, write: if true;' (Untuk Test Mode).");
                    } else {
                        alert("Gagal simpan: " + e.message); 
                    }
                }
            }

            if(!auth) return <div className="max-w-sm mx-auto mt-10 bg-white p-8 rounded shadow text-center"><Lock className="mx-auto mb-4 text-emerald-600"/><h2 className="font-bold mb-4">Akses Input</h2><form onSubmit={e=>{e.preventDefault(); pin==="11335577"?setAuth(true):alert("PIN Salah")}}><input type="password" value={pin} onChange={e=>setPin(e.target.value)} className="w-full border p-2 text-center mb-4 rounded" placeholder="Masukkan PIN Admin"/><button className="w-full bg-emerald-600 text-white py-2 rounded">Masuk</button><p className="text-xs text-gray-400 text-center mt-2">PIN hubungi admin</p></form></div>
            
            if(mode === 'select') return <div className="max-w-xl mx-auto mt-8 grid grid-cols-2 gap-4"><button onClick={()=>setMode('scan')} className="bg-white p-8 rounded shadow hover:bg-gray-50 text-center"><ScanLine size={40} className="mx-auto mb-2 text-blue-600"/><div className="font-bold">Scan Struk</div></button><button onClick={()=>setMode('manual')} className="bg-white p-8 rounded shadow hover:bg-gray-50 text-center"><Keyboard size={40} className="mx-auto mb-2 text-orange-600"/><div className="font-bold">Manual</div></button></div>

            if(mode === 'scan' && !preview) return <div className="max-w-md mx-auto mt-8 bg-white p-8 rounded shadow text-center relative"><button onClick={()=>setMode('select')} className="absolute top-4 left-4 text-gray-400">Kembali</button><Upload size={48} className="mx-auto mb-4 text-gray-300"/><p>Upload Foto Struk</p><input type="file" accept="image/*" onChange={handleFile} className="absolute inset-0 opacity-0 cursor-pointer"/></div>

            return (
                <div className="max-w-2xl mx-auto mt-4 bg-white p-6 rounded shadow relative">
                    {scanning && <div className="absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-600"></div><p className="mt-2">Menganalisa Struk...</p></div>}
                    <button onClick={()=>{setMode('select');setPreview(null);setForm({name:"",date:"",time:"",amount:"",bank:""})}} className="text-sm text-gray-500 mb-4">Kembali</button>
                    <div className="grid md:grid-cols-2 gap-6">
                        {preview && <img src={preview} className="w-full h-64 object-contain border rounded bg-gray-50"/>}
                        <form onSubmit={save} className={!preview?'col-span-2 space-y-4':'space-y-4'}>
                            <input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full border p-2 rounded" placeholder="Nama Donatur"/>
                            <div className="grid grid-cols-2 gap-2">
                                <input type="date" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} className="w-full border p-2 rounded"/>
                                <input type="time" value={form.time} onChange={e=>setForm({...form,time:e.target.value})} className="w-full border p-2 rounded"/>
                            </div>
                            <select value={form.bank} onChange={e=>setForm({...form,bank:e.target.value})} className="w-full border p-2 rounded bg-white"><option value="">Pilih Bank</option>{["BSI","BCA","Mandiri","BRI","BNI","Muamalat","Jago Syariah","Lainnya"].map(b=><option key={b} value={b}>{b}</option>)}</select>
                            <input type="number" value={form.amount} onChange={e=>setForm({...form,amount:e.target.value})} className="w-full border p-2 rounded font-bold text-emerald-700" placeholder="Nominal (Rp)"/>
                            <button className="w-full bg-emerald-600 text-white py-3 rounded font-bold hover:bg-emerald-700">Simpan Data</button>
                        </form>
                    </div>
                </div>
            )
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
