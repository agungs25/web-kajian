<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Tensi Harian</title>
    <!-- 
      Icon (Font Awesome) untuk ikon-ikon di aplikasi.
      Ini menggantikan SVG inline agar lebih mudah dikelola.
    -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- CSS Kustom dari pakde.css -->
    <style>
      :root {
        --green-1: #0f5132; /* dark */
        --green-2: #198754; /* primary */
        --green-3: #d1e7dd; /* pale */
        --green-4: #e9f7f1; /* bg */

        /* Variabel tambahan untuk UI */
        --red-light: #f8d7da;
        --red-dark: #842029;
        --yellow-light: #fff3cd;
        --yellow-dark: #664d03;
        --blue-light: #cfe2ff;
        --blue-dark: #0a58ca;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 0;
        background: var(--green-4);
        color: #123;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      header {
        background: linear-gradient(135deg, var(--green-2), var(--green-1));
        color: #fff;
        padding: 24px 16px;
        text-align: center;
        border-bottom: 4px solid var(--green-1);
      }
      header h1 {
        margin: 0 0 6px;
        font-size: clamp(20px, 4vw, 26px);
        font-weight: 700;
      }
      header p {
        margin: 0;
        opacity: .95;
        font-size: 15px;
      }

      main {
        max-width: 800px;
        margin: 20px auto;
        padding: 0 16px 32px 16px;
      }
      
      /* ID Pengguna & Status Box */
      .user-id-box {
        font-size: 13px;
        color: var(--green-1);
        background: #fff;
        border: 1px solid var(--green-3);
        padding: 10px 14px;
        border-radius: 12px;
        text-align: center;
        word-break: break-all;
        box-shadow: 0 1px 3px rgba(16, 94, 60, .05);
      }
      .user-id-box strong {
        font-weight: 600;
      }
      
      /* Status Box (Auth & Pesan) */
      .status-box {
        padding: 12px 16px;
        border-radius: 12px;
        margin-top: 16px;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid;
      }
      .status-box.success {
        background: var(--green-3);
        color: var(--green-1);
        border-color: var(--green-2);
      }
      .status-box.error {
        background: var(--red-light);
        color: var(--red-dark);
        border-color: var(--red-dark);
      }
      .status-box.loading {
        background: var(--yellow-light);
        color: var(--yellow-dark);
        border-color: var(--yellow-dark);
      }
      .status-box i {
        font-size: 16px;
      }

      .card {
        background: #fff;
        border-radius: 14px;
        padding: 16px 20px;
        border: 1px solid #e6f0ea;
        box-shadow: 0 2px 8px rgba(16, 94, 60, .06);
        margin-top: 20px;
      }
      .card h2 {
        margin: 0 0 16px;
        font-size: 18px;
        color: var(--green-1);
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
      }
      
      /* Form Input */
      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        display: block;
        font-weight: 600;
        font-size: 14px;
        color: #333;
        margin-bottom: 6px;
      }
      
      .input-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      
      /* Styling untuk Input, Select */
      input[type="text"],
      input[type="number"],
      input[type="date"],
      input[type="time"],
      select {
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid #cfe3d8;
        background: #fff;
        box-shadow: 0 1px 0 #fff inset;
        width: 100%;
        font-size: 16px;
        font-family: inherit;
        color: #333;
      }
      input[type="text"]:focus,
      input[type="number"]:focus,
      input[type="date"]:focus,
      input[type="time"]:focus,
      select:focus {
        outline: none;
        border-color: var(--green-2);
        box-shadow: 0 0 0 2px var(--green-3);
      }
      input::placeholder {
        color: #999;
      }

      /* Tombol */
      .btn {
        text-decoration: none;
        display: inline-block;
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid transparent;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        width: 100%;
        font-family: inherit;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn-green {
        background: var(--green-2);
        color: #fff;
        border-color: var(--green-1);
      }
      .btn-green:hover {
        background: var(--green-1);
      }
      .btn:disabled {
        background: #ccc;
        border-color: #999;
        color: #666;
        cursor: not-allowed;
      }

      /* Grafik Canvas */
      #trendChart {
        width: 100%;
        height: 250px;
        background: #fdfdfd;
        border-radius: 8px;
        border: 1px solid #eee;
      }
      .chart-placeholder {
        width: 100%;
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px dashed #ccc;
        color: #777;
        font-style: italic;
      }

      /* Tabel Riwayat */
      .table-wrapper {
        width: 100%;
        overflow-x: auto;
        border: 1px solid #e6f0ea;
        border-radius: 12px;
        background: #fff;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        padding: 12px 14px;
        text-align: left;
        font-size: 14px;
        border-bottom: 1px solid #e6f0ea;
      }
      th {
        background: var(--green-4);
        color: var(--green-1);
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover {
        background-color: #fcfcfc;
      }
      .table-placeholder td {
        text-align: center;
        color: #777;
        font-style: italic;
        padding: 20px;
      }

      /* Badge Kategori */
      .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
      }
      .badge-normal { background: var(--green-3); color: var(--green-1); }
      .badge-elevated { background: var(--yellow-light); color: var(--yellow-dark); }
      .badge-high-1 { background: #ffc9a8; color: #a14000; }
      .badge-high-2 { background: var(--red-light); color: var(--red-dark); }
      .badge-crisis { background: #000; color: #fff; }
      
      .badge-pulse-low { background: var(--blue-light); color: var(--blue-dark); }
      .badge-pulse-normal { background: var(--green-3); color: var(--green-1); }
      .badge-pulse-high { background: var(--red-light); color: var(--red-dark); }
      

      footer {
        text-align: center;
        margin: 24px 0 36px;
        color: #555;
        font-size: 13px;
      }
      footer a {
        color: var(--green-2);
        font-weight: 600;
      }

    </style>
</head>
<body>

    <header>
        <h1>Monitor Tensi Harian</h1>
        <p>Aplikasi untuk penderita hipertensi: Catat Tensi Pagi & Sore</p>
    </header>

    <main>
        <!-- ID Pengguna & Status Autentikasi -->
        <div class="user-id-box">
            <strong>ID Pengguna:</strong> <span id="userIdDisplay">Menunggu Autentikasi...</span>
        </div>
        
        <div id="authStatus" class="status-box loading">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <span>Mencoba autentikasi...</span>
        </div>

        <!-- 
          CARD 1: INPUT DATA BARU
        -->
        <div class="card">
            <h2><i class="fa-solid fa-file-medical"></i>Input Tensi Baru</h2>

            <!-- Input Tensi (Sistolik, Diastolik) & Pulse -->
            <div class="input-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="form-group">
                    <label for="systolic">Sistolik (atas)</label>
                    <input type="number" id="systolic" placeholder="e.g. 135" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="diastolic">Diastolik (bawah)</label>
                    <input type="number" id="diastolic" placeholder="e.g. 85" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="pulse">Pulse (detak/menit)</label>
                    <input type="number" id="pulse" placeholder="e.g. 70" inputmode="numeric">
                </div>
            </div>
            
            <hr style="border:none; border-top: 1px dashed #eee; margin: 0 0 16px 0;">

            <!-- Input Waktu (Tanggal & Pilihan Pagi/Malam) -->
            <div class="input-grid">
                <div class="form-group">
                    <label for="inputDate">Tanggal (Kosongkan = Hari Ini)</label>
                    <input type="date" id="inputDate">
                </div>
                <div class="form-group">
                    <label for="timeOfDay">Waktu Pengukuran</label>
                    <select id="timeOfDay">
                        <option value="">Otomatis (Saat Ini)</option>
                        <option value="Pagi">Pagi (08:00)</option>
                        <option value="Malam">Malam (20:00)</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-top: 16px; margin-bottom: 0;">
                <button id="saveButton" class="btn btn-green">
                    <i class="fa-solid fa-floppy-disk"></i>
                    <span>Simpan Data Tensi</span>
                </button>
            </div>
        </div>


        <!-- 
          CARD 2: GRAFIK TREN
        -->
        <div class="card">
            <h2><i class="fa-solid fa-chart-line"></i>Tren Tensi (Rata-rata 7 Hari Terakhir)</h2>
            <div id="chartContainer">
                <!-- Placeholder akan diganti canvas oleh JS -->
                <div class="chart-placeholder" id="chartPlaceholder">
                    Memuat data grafik...
                </div>
            </div>
            <canvas id="trendChart" style="display: none;"></canvas>
        </div>
        
        <!-- 
          CARD 3: RIWAYAT DATA
        -->
        <div class="card">
            <h2><i class="fa-solid fa-clock-rotate-left"></i>Riwayat 10 Data Terbaru</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Waktu</th>
                            <th>Tensi (mmHg)</th>
                            <th>Pulse</th>
                            <th>Kategori</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- Placeholder data -->
                        <tr class="table-placeholder">
                            <td colspan="5">Memuat data riwayat...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <footer>
        Dibuat untuk monitoring hipertensi.
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // Import fungsi yang diperlukan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot, 
            limit, 
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Aktifkan log debug untuk Firebase (membantu troubleshooting)
        setLogLevel('debug');

        // --- Variabel Global Aplikasi ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false; // Flag untuk menandai autentikasi selesai
        let readingsListener = null; // Penyimpan fungsi listener onSnapshot
        let chartInstance = null; // Penyimpan instance grafik

        // --- Elemen UI ---
        const authStatusEl = document.getElementById('authStatus');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const saveButton = document.getElementById('saveButton');
        const systolicInput = document.getElementById('systolic');
        const diastolicInput = document.getElementById('diastolic');
        const pulseInput = document.getElementById('pulse');
        const inputDateEl = document.getElementById('inputDate');
        const timeOfDayEl = document.getElementById('timeOfDay');
        const historyTableBody = document.getElementById('historyTableBody');
        const chartContainer = document.getElementById('chartContainer');
        const chartPlaceholder = document.getElementById('chartPlaceholder');
        const canvas = document.getElementById('trendChart');
        const ctx = canvas.getContext('2d');

        // --- 1. Konfigurasi Firebase (Self-Hosting) ---

        /**
         * Mendapatkan konfigurasi Firebase.
         * Jika di-host di lingkungan khusus, gunakan variabel global.
         * Jika di-host mandiri, gunakan objek config di bawah ini.
         */
        function getFirebaseConfig() {
            // Cek apakah variabel global dari lingkungan kanvas ada
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                console.log("Menggunakan konfigurasi Firebase dari kanvas.");
                try {
                    return JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Gagal mem-parsing __firebase_config:", e);
                    return null;
                }
            }
            
            // --- PENTING UNTUK SELF-HOSTING ---
            // Ganti nilai di bawah ini dengan konfigurasi Firebase Anda
            // yang didapat dari Firebase Console (Pengaturan Proyek > Aplikasi Web).
            console.log("Menggunakan konfigurasi Firebase self-hosted.");
            const firebaseConfig = {
                apiKey: "AIzaSyC70xZ8VsDlfbsa-_JNmNoh6qdf9-PdJgk",
                authDomain: "monitor-tensi.firebaseapp.com",
                projectId: "monitor-tensi",
                storageBucket: "monitor-tensi.firebasestorage.app",
                messagingSenderId: "917331085991",
                appId: "1:917331085991:web:037e3650f60776db53e982"
            };
            
            // Validasi sederhana
            if (firebaseConfig.apiKey === "AIzaSyC70xZ8VsDlfbsa-_JNmNoh6qdf9-PdJgk" || !firebaseConfig.projectId) {
                console.error("Konfigurasi Firebase belum diisi. Harap edit file HTML.");
                return null;
            }
            
            return firebaseConfig;
        }

        /**
         * Mendapatkan token autentikasi.
         * Jika di lingkungan kanvas, gunakan token yang disediakan.
         * Jika self-hosted, return null (akan menggunakan signInAnonymously).
         */
        function getAuthToken() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                console.log("Menggunakan token autentikasi dari kanvas.");
                return __initial_auth_token;
            }
            console.log("Tidak ada token autentikasi kanvas. Akan menggunakan login anonim.");
            return null;
        }

        // --- 2. Inisialisasi dan Autentikasi Firebase ---

        async function initializeFirebase() {
            const firebaseConfig = getFirebaseConfig();
            
            if (!firebaseConfig) {
                updateAuthStatus("EROR: Konfigurasi Firebase tidak ditemukan. Harap edit file HTML untuk self-hosting.", "error");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                console.log("Firebase App & Firestore diinisialisasi.");
                
                // Pantau status autentikasi
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Pengguna sudah login
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Autentikasi BERHASIL. UserID:", userId);
                        userIdDisplayEl.textContent = userId;
                        updateAuthStatus("Autentikasi BERHASIL. Data dimuat secara real-time.", "success");
                        
                        // Mulai mendengarkan data setelah auth siap
                        setupDataListener();
                        
                    } else {
                        // Pengguna belum login, coba login
                        console.log("Belum ada pengguna. Mencoba login...");
                        const token = getAuthToken();
                        
                        try {
                            if (token) {
                                // Skenario 1: Login dengan token kustom (Lingkungan Kanvas)
                                await signInWithCustomToken(auth, token);
                                console.log("Login dengan Custom Token berhasil.");
                            } else {
                                // Skenario 2: Login anonim (Self-Hosting)
                                await signInAnonymously(auth);
                                console.log("Login Anonim berhasil.");
                            }
                            // onAuthStateChanged akan dipanggil lagi setelah login berhasil
                            
                        } catch (authError) {
                            console.error("Gagal melakukan autentikasi:", authError);
                            isAuthReady = false;
                            updateAuthStatus(`EROR Autentikasi: ${authError.message}`, "error");
                        }
                    }
                });

            } catch (e) {
                console.error("Gagal inisialisasi Firebase:", e);
                updateAuthStatus(`EROR Inisialisasi: ${e.message}`, "error");
            }
        }

        // --- 3. Logika Aplikasi (Simpan & Baca Data) ---

        /**
         * Menyiapkan listener real-time (onSnapshot) ke Firestore.
         */
        function setupDataListener() {
            if (!db || !userId || !isAuthReady) {
                console.warn("Mencoba setup listener sebelum auth siap. Menunggu...");
                return;
            }
            
            // Jika sudah ada listener, hentikan dulu
            if (readingsListener) {
                readingsListener();
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const readingsColPath = `artifacts/${appId}/users/${userId}/bloodPressureReadings`;
            
            console.log("Menyiapkan listener untuk koleksi:", readingsColPath);

            const q = query(
                collection(db, readingsColPath)
                // Hapus orderBy karena memerlukan indeks komposit manual di Firestore
                // Kita akan urutkan di client-side
                // orderBy("timestamp", "desc"), 
                // limit(50) // Ambil 50 data terakhir, urutkan nanti
            );

            readingsListener = onSnapshot(q, (snapshot) => {
                console.log("Menerima data snapshot baru...");
                const readings = [];
                snapshot.forEach(doc => {
                    readings.push({ id: doc.id, ...doc.data() });
                });
                
                // Urutkan data di client-side (terbaru dulu)
                readings.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                // Proses data untuk tabel (ambil 10 terbaru)
                updateHistoryTable(readings.slice(0, 10));
                
                // Proses data untuk grafik (7 hari terakhir)
                updateChart(readings);

            }, (error) => {
                console.error("Error mendengarkan data (onSnapshot):", error);
                updateAuthStatus(`EROR Baca Data: ${error.message}`, "error");
                historyTableBody.innerHTML = `<tr class="table-placeholder"><td colspan="5">Gagal memuat data.</td></tr>`;
                chartPlaceholder.textContent = "Gagal memuat data grafik.";
            });
        }

        /**
         * Menyimpan data bacaan baru ke Firestore.
         */
        async function saveReading() {
            if (!db || !userId || !isAuthReady) {
                console.error("Tidak bisa menyimpan: Autentikasi belum siap.");
                updateAuthStatus("EROR: Belum terautentikasi. Coba muat ulang halaman.", "error");
                return;
            }

            const systolic = parseInt(systolicInput.value);
            const diastolic = parseInt(diastolicInput.value);
            const pulse = parseInt(pulseInput.value) || null; // Pulse opsional
            
            const inputDate = inputDateEl.value; // YYYY-MM-DD
            const timeOfDay = timeOfDayEl.value; // "Pagi", "Malam", ""

            // Validasi input dasar
            if (isNaN(systolic) || isNaN(diastolic) || systolic <= 0 || diastolic <= 0) {
                updateAuthStatus("EROR: Sistolik dan Diastolik harus diisi angka yang valid.", "error");
                return;
            }

            // --- Logika Penentuan Timestamp ---
            let finalTimestamp;
            const now = new Date();

            if (inputDate) {
                // Pengguna memasukkan tanggal
                const [year, month, day] = inputDate.split('-').map(Number);
                const selectedDate = new Date(year, month - 1, day);

                if (timeOfDay === "Pagi") {
                    selectedDate.setHours(8, 0, 0, 0); // Jam 8:00 Pagi
                } else if (timeOfDay === "Malam") {
                    selectedDate.setHours(20, 0, 0, 0); // Jam 8:00 Malam
                } else {
                    // Jika hanya tanggal, set ke jam 12 siang (netral)
                    selectedDate.setHours(12, 0, 0, 0);
                }
                finalTimestamp = Timestamp.fromDate(selectedDate);
                
            } else {
                // Pengguna tidak memasukkan tanggal, gunakan waktu saat ini
                // Hormati pilihan Pagi/Malam jika ada, tapi gunakan tanggal HARI INI
                if (timeOfDay === "Pagi") {
                    now.setHours(8, 0, 0, 0);
                } else if (timeOfDay === "Malam") {
                    now.setHours(20, 0, 0, 0);
                }
                // Jika timeOfDay kosong, 'now' sudah benar (waktu saat ini)
                finalTimestamp = Timestamp.fromDate(now);
            }
            
            // Tentukan label Waktu (Pagi/Malam/Jam)
            const displayTime = timeOfDay || finalTimestamp.toDate().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            const newReading = {
                systolic: systolic,
                diastolic: diastolic,
                pulse: pulse,
                timestamp: finalTimestamp,
                displayTime: displayTime, // Simpan label Pagi/Malam/Jam
                createdAt: Timestamp.now()
            };

            // Nonaktifkan tombol saat menyimpan
            toggleButton(saveButton, "Menyimpan...", true);

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const readingsColPath = `artifacts/${appId}/users/${userId}/bloodPressureReadings`;
                
                await addDoc(collection(db, readingsColPath), newReading);
                
                console.log("Data berhasil disimpan.");
                updateAuthStatus("Data berhasil disimpan! Riwayat diperbarui.", "success");

                // Kosongkan input
                systolicInput.value = '';
                diastolicInput.value = '';
                pulseInput.value = '';
                inputDateEl.value = '';
                timeOfDayEl.value = '';

            } catch (e) {
                console.error("Gagal menyimpan data:", e);
                updateAuthStatus(`EROR Simpan: ${e.message}`, "error");
            } finally {
                // Aktifkan kembali tombol
                toggleButton(saveButton, "Simpan Data Tensi", false);
            }
        }

        // --- 4. Fungsi Utilitas & Tampilan ---

        /**
         * Memperbarui kotak status autentikasi/pesan.
         */
        function updateAuthStatus(message, type = "success") {
            authStatusEl.className = `status-box ${type}`;
            let iconClass = "fa-solid fa-check-circle";
            if (type === "error") iconClass = "fa-solid fa-exclamation-triangle";
            if (type === "loading") iconClass = "fa-solid fa-spinner fa-spin";
            
            authStatusEl.innerHTML = `<i class="${iconClass}"></i> <span>${message}</span>`;
            
            // Sembunyikan pesan sukses setelah 3 detik
            if (type === "success" && message.startsWith("Data berhasil disimpan")) {
                setTimeout(() => {
                    // Hanya sembunyikan jika pesannya masih sama (tidak ditimpa error lain)
                    if (authStatusEl.textContent.includes("Data berhasil disimpan")) {
                         updateAuthStatus("Autentikasi BERHASIL. Data dimuat secara real-time.", "success");
                    }
                }, 3000);
            }
        }
        
        /**
         * Mengaktifkan/menonaktifkan tombol dan mengubah teksnya.
         */
        function toggleButton(button, text, disabled) {
            button.disabled = disabled;
            const textSpan = button.querySelector('span');
            const icon = button.querySelector('i');
            
            if (textSpan) textSpan.textContent = text;
            
            if (disabled) {
                icon.className = "fa-solid fa-spinner fa-spin";
            } else {
                icon.className = "fa-solid fa-floppy-disk";
            }
        }

        /**
         * Mengkategorikan tekanan darah.
         */
        function getPressureCategory(sys, dia) {
            if (sys < 120 && dia < 80) return { text: "Normal", class: "badge-normal" };
            if (sys >= 120 && sys <= 129 && dia < 80) return { text: "Elevated", class: "badge-elevated" };
            if ((sys >= 130 && sys <= 139) || (dia >= 80 && dia <= 89)) return { text: "Hipertensi Stg 1", class: "badge-high-1" };
            if (sys >= 140 || dia >= 90) return { text: "Hipertensi Stg 2", class: "badge-high-2" };
            if (sys > 180 || dia > 120) return { text: "Krisis Hipertensi", class: "badge-crisis" };
            return { text: "N/A", class: "badge-normal" };
        }
        
        /**
         * Mengkategorikan detak jantung (pulse).
         */
        function getPulseCategory(pulse) {
            if (!pulse) return { text: "N/A", class: "badge-normal" };
            if (pulse < 60) return { text: "Rendah", class: "badge-pulse-low" };
            if (pulse > 100) return { text: "Tinggi", class: "badge-pulse-high" };
            return { text: "Normal", class: "badge-pulse-normal" };
        }

        /**
         * Memformat Firestore Timestamp ke tanggal (DD/MM/YYYY).
         */
        function formatTimestampDate(timestamp) {
            if (!timestamp) return "N/A";
            return timestamp.toDate().toLocaleDateString('id-ID', {
                day: '2-digit', month: '2-digit', year: 'numeric'
            });
        }
        
        /**
         * Memformat Firestore Timestamp ke waktu (Pagi/Malam/Jam).
         */
        function formatTimestampTime(timestamp, displayTime) {
             if (displayTime) return displayTime; // Gunakan label Pagi/Malam jika ada
             if (!timestamp) return "N/A";
             return timestamp.toDate().toLocaleTimeString('id-ID', {
                hour: '2-digit', minute: '2-digit'
             });
        }

        /**
         * Memperbarui tabel riwayat di UI.
         */
        function updateHistoryTable(readings) {
            if (readings.length === 0) {
                historyTableBody.innerHTML = `<tr class="table-placeholder"><td colspan="5">Belum ada data tensi yang tersimpan.</td></tr>`;
                return;
            }

            historyTableBody.innerHTML = '';
            readings.forEach(reading => {
                const pressureCat = getPressureCategory(reading.systolic, reading.diastolic);
                const pulseCat = getPulseCategory(reading.pulse);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatTimestampDate(reading.timestamp)}</td>
                    <td><b>${formatTimestampTime(reading.timestamp, reading.displayTime)}</b></td>
                    <td>${reading.systolic} / ${reading.diastolic}</td>
                    <td>${reading.pulse || 'N/A'}</td>
                    <td>
                        <span class="badge ${pressureCat.class}">${pressureCat.text}</span>
                        ${reading.pulse ? `<span class="badge ${pulseCat.class}">${pulseCat.text}</span>` : ''}
                    </td>
                `;
                historyTableBody.appendChild(tr);
            });
        }
        
        /**
         * Memperbarui grafik tren.
         */
        function updateChart(allReadings) {
            if (allReadings.length < 2) {
                chartPlaceholder.textContent = "Data tidak cukup untuk grafik (Min. 2 data).";
                chartPlaceholder.style.display = 'flex';
                canvas.style.display = 'none';
                return;
            }

            // --- Logika Agregasi Data untuk Grafik (7 Hari Terakhir) ---
            const dataByDay = {};
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            sevenDaysAgo.setHours(0, 0, 0, 0);

            allReadings.forEach(r => {
                const date = r.timestamp.toDate();
                if (date >= sevenDaysAgo) {
                    const dayString = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                    if (!dataByDay[dayString]) {
                        dataByDay[dayString] = { sys: [], dia: [], timestamps: [] };
                    }
                    dataByDay[dayString].sys.push(r.systolic);
                    dataByDay[dayString].dia.push(r.diastolic);
                    dataByDay[dayString].timestamps.push(date.getTime());
                }
            });

            // Hitung rata-rata per hari dan urutkan
            const chartData = Object.keys(dataByDay).map(day => {
                const sysAvg = dataByDay[day].sys.reduce((a, b) => a + b, 0) / dataByDay[day].sys.length;
                const diaAvg = dataByDay[day].dia.reduce((a, b) => a + b, 0) / dataByDay[day].dia.length;
                const avgTimestamp = dataByDay[day].timestamps.reduce((a, b) => a + b, 0) / dataByDay[day].timestamps.length;
                return {
                    label: day,
                    timestamp: avgTimestamp,
                    sys: Math.round(sysAvg),
                    dia: Math.round(diaAvg)
                };
            }).sort((a, b) => a.timestamp - b.timestamp); // Urutkan dari terlama ke terbaru
            
            if (chartData.length < 2) {
                chartPlaceholder.textContent = "Data tidak cukup dalam 7 hari terakhir (Min. 2 hari berbeda).";
                chartPlaceholder.style.display = 'flex';
                canvas.style.display = 'none';
                return;
            }

            // Sembunyikan placeholder, tampilkan canvas
            chartPlaceholder.style.display = 'none';
            canvas.style.display = 'block';

            // Hancurkan grafik lama jika ada
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Gambar ulang grafik menggunakan Chart.js (v4+) - Versi Sederhana Tanpa Library
            drawSimpleChart(chartData);
        }

        /**
         * Fungsi menggambar grafik sederhana di Canvas HTML5.
         * Ini menghindari perlunya mengimpor library Chart.js eksternal.
         */
        function drawSimpleChart(data) {
            const padding = 40;
            const width = canvas.width;
            const height = canvas.height;
            const usableWidth = width - padding * 2;
            const usableHeight = height - padding * 2;

            const labels = data.map(d => d.label);
            const sysData = data.map(d => d.sys);
            const diaData = data.map(d => d.dia);

            const allData = [...sysData, ...diaData, 80, 130]; // Termasuk garis batas
            const minVal = Math.min(...allData) - 10;
            const maxVal = Math.max(...allData) + 10;
            const range = maxVal - minVal;

            const xStep = usableWidth / (labels.length - 1 || 1);
            const y = (val) => usableHeight - ((val - minVal) / range) * usableHeight + padding;
            const x = (i) => i * xStep + padding;

            // Bersihkan canvas
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, width, height);

            // --- Gambar Garis Grid dan Label Sumbu Y ---
            ctx.strokeStyle = '#eee';
            ctx.fillStyle = '#777';
            ctx.font = '12px Arial';
            ctx.lineWidth = 1;
            
            const yLabels = [Math.round(minVal + range * 0.25), Math.round(minVal + range * 0.5), Math.round(minVal + range * 0.75)];
            [...yLabels, 130, 80].forEach(val => {
                const yPos = y(val);
                ctx.beginPath();
                
                // Garis batas (Normal/Elevated)
                if (val === 130 || val === 80) {
                    ctx.setLineDash([5, 5]); // Garis putus-putus
                    ctx.strokeStyle = (val === 130) ? 'orange' : 'green';
                } else {
                    ctx.setLineDash([]);
                    ctx.strokeStyle = '#eee';
                }
                
                ctx.moveTo(padding, yPos);
                ctx.lineTo(width - padding, yPos);
                ctx.stroke();
                
                ctx.textAlign = 'right';
                ctx.fillText(val.toString(), padding - 8, yPos + 4);
            });
            ctx.setLineDash([]); // Reset garis

            // --- Gambar Label Sumbu X ---
            ctx.textAlign = 'center';
            labels.forEach((label, i) => {
                ctx.fillText(label, x(i), height - padding + 20);
            });

            // --- Gambar Garis Data (Sistolik & Diastolik) ---
            
            // Fungsi untuk menggambar garis dan titik
            const drawLine = (dataset, color) => {
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = 2.5;
                
                ctx.beginPath();
                ctx.moveTo(x(0), y(dataset[0]));
                dataset.forEach((val, i) => {
                    if (i > 0) ctx.lineTo(x(i), y(val));
                });
                ctx.stroke();

                // Gambar titik
                dataset.forEach((val, i) => {
                    ctx.beginPath();
                    ctx.arc(x(i), y(val), 4, 0, Math.PI * 2);
                    ctx.fill();
                });
            };
            
            drawLine(sysData, 'rgba(219, 58, 52, 0.8)'); // Merah untuk Sistolik
            drawLine(diaData, 'rgba(26, 115, 232, 0.8)'); // Biru untuk Diastolik
        }


        // --- 5. Event Listeners ---

        saveButton.addEventListener('click', saveReading);
        
        // Mulai aplikasi saat DOM siap
        document.addEventListener('DOMContentLoaded', () => {
             initializeFirebase();
        });

    </script>
</body>
</html>
